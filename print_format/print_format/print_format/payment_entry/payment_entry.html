<!-- PDF Margins - Meta Tags for wkhtmltopdf -->
<meta name="margin-top" content="5mm">
<meta name="margin-bottom" content="5mm">
<meta name="margin-left" content="5mm">
<meta name="margin-right" content="5mm">


<!-- Letterhead -->
<div style="height:5px;"></div>
<div style="width:100%; text-align:center; margin:0 0 5px 0;">
  <img src="/files/company.png" alt="Letterhead" style="max-width:100%; height:auto; display:block; margin:0 auto;">
</div>

<!-- Heading -->
<div style="height:5px;"></div>

<div style="width:100%;max-width:100%;margin:0 0 5px 0;padding:0;background:#fff;font-family:'Cairo',Tahoma,Arial,sans-serif;box-sizing:border-box;box-shadow:0 1px 3px rgba(255,182,49,0.09);direction:rtl;overflow:hidden;">
  <div style="display:flex;justify-content:center;align-items:center;padding:4px 10px;line-height:1;text-align:center;white-space:nowrap;font-weight:bold;color:#000;font-size:1.4em;letter-spacing:.5px;">
    {% if doc.payment_type == "Receive" %}
      إذن استلام
    {% elif doc.payment_type == "Pay" %}
      إذن دفع
    {% else %}
      تحويل داخلي
    {% endif %}
  </div>
</div>

<!-- Party Info -->
<div style="border:1.5pt solid #000; border-radius:8pt; background:#fff; width:100%; margin:0 0 2pt 0; padding:0; font-family:'Cairo',Tahoma,Arial,sans-serif; direction:rtl; box-sizing:border-box;">
  <table style="width:100%; border-collapse:collapse; margin:0; padding:0; line-height:1.1; font-family:'Cairo',Tahoma,Arial,sans-serif; table-layout:auto;">
    <tbody>
      {% if doc.party_type and doc.party %}
        {% if doc.party_type == "Customer" %}
          {% set party_doc = frappe.get_doc("Customer", doc.party) %}
        {% elif doc.party_type == "Supplier" %}
          {% set party_doc = frappe.get_doc("Supplier", doc.party) %}
        {% else %}
          {% set party_doc = None %}
        {% endif %}
      {% else %}
        {% set party_doc = None %}
      {% endif %}

      <tr style="font-size:10pt; line-height:1.1; white-space:nowrap;">
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">
          {% if doc.payment_type == "Receive" %}
            اسم العميل
          {% elif doc.payment_type == "Pay" %}
            اسم المورد
          {% else %}
            الطرف
          {% endif %}
        </td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ doc.party_name or doc.party or "" }}</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">رقم الإذن</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ doc.name }}</td>
      </tr>
      
      {% if doc.party_type and doc.party %}
        {% set address_name = frappe.db.get_value("Dynamic Link", {"link_doctype": doc.party_type, "link_name": doc.party}, "parent") %}
      {% else %}
        {% set address_name = None %}
      {% endif %}
      {% set address_line2 = "" %}{% set custom_area = "" %}{% set address_line1 = "" %}{% set city = "" %}{% set pincode = "" %}
      {% if address_name %}
        {% set address_values = frappe.db.get_value("Address", address_name, ["address_line2","custom_area","address_line1","city","pincode"]) %}
        {% if address_values %}
          {% set address_line2 = address_values[0] %}{% set custom_area = address_values[1] %}{% set address_line1 = address_values[2] %}{% set city = address_values[3] %}{% set pincode = address_values[4] %}
        {% endif %}
      {% endif %}
      <tr style="font-size:10pt; line-height:1.1; white-space:nowrap;">
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">العنوان</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">
          {% set address_parts = [] %}
          {% if address_line2 %}{% set _ = address_parts.append(address_line2) %}{% endif %}
          {% if custom_area %}{% set _ = address_parts.append(custom_area) %}{% endif %}
          {% if address_line1 %}{% set _ = address_parts.append(address_line1) %}{% endif %}
          {% if city %}{% set _ = address_parts.append(city) %}{% endif %}
          {{ address_parts | join(', ') }}
        </td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">تاريخ الإذن</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">
          {% set days_ar = ['الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت','الأحد'] %}
          {% set dt = frappe.utils.get_datetime(doc.posting_date) %}
          {% set weekday = dt.weekday() %}
          {{ days_ar[weekday] }} {{ "%02d"|format(dt.day) }}-{{ "%02d"|format(dt.month) }}-{{ dt.year }}
        </td>
      </tr>

      <tr style="font-size:10pt; line-height:1.1; white-space:nowrap;">
        {% if party_doc and party_doc.custom_vat_registration_number %}
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">الرقم الضريبي</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ party_doc.custom_vat_registration_number }}</td>
        {% else %}
        <td style="border:none; width:15%; vertical-align:middle;"></td>
        <td style="border:none; width:35%; vertical-align:middle;"></td>
        {% endif %}
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">وقت الإذن</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">
          {% if doc.custom_posting_time %}
            {% set dt_time = frappe.utils.get_datetime(doc.posting_date ~ ' ' ~ doc.custom_posting_time) %}
            {% set hour = dt_time.hour %}
            {% set minute = dt_time.minute %}
            {% set hour12 = hour if 1 <= hour <= 12 else (hour - 12 if hour > 12 else 12) %}
            {% set am_pm_ar = 'ص' if hour < 12 else 'م' %}
            {{ hour12 }}:{{ "%02d"|format(minute) }} {{ am_pm_ar }}
          {% else %}
            {% set dt_time = frappe.utils.get_datetime(doc.posting_date) %}
            {% set hour = dt_time.hour %}
            {% set minute = dt_time.minute %}
            {% set hour12 = hour if 1 <= hour <= 12 else (hour - 12 if hour > 12 else 12) %}
            {% set am_pm_ar = 'ص' if hour < 12 else 'م' %}
            {{ hour12 }}:{{ "%02d"|format(minute) }} {{ am_pm_ar }}
          {% endif %}
        </td>
      </tr>
      
      {% if party_doc %}
        {% set type_ar = {
          "Tax Identification Number": ["الرقم الضريبي"],
          "Commercial Registration Number": ["السجل التجاري"],
          "MOMRAH License": ["رخصة وزارة الشؤون البلدية والقروية والإسكان"],
          "MHRSD License": ["رخصة وزارة الموارد البشرية والتنمية الاجتماعية"],
          "700 Number": ["الرقم الموحد"],
          "MISA License": ["رخصة وزارة الاستثمار"],
          "National ID": ["الهوية الوطنية"],
          "GCC ID": ["هوية مجلس التعاون"],
          "Iqama": ["رقم الإقامة"],
          "Passport ID": ["رقم جواز السفر"],
          "Other OD": ["أخرى"]
        } %}
        {% if party_doc.custom_additional_ids %}
          {% for row in party_doc.custom_additional_ids %}
            {% if row.value %}
            <tr style="font-size:10pt; line-height:1.1; white-space:nowrap;">
              <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">{{ type_ar.get(row.type_name, [row.type_name])[0] }}</td>
              <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ row.value }}</td>
              {% if loop.index == 2 %}
                <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">طريقة الدفع</td>
                <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ doc.mode_of_payment or "" }}</td>
              {% else %}
                <td style="border:none; width:15%; vertical-align:middle;"></td><td style="border:none; width:35%; vertical-align:middle;"></td>
              {% endif %}
            </tr>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}

      {% if not party_doc or (party_doc and (not party_doc.custom_additional_ids or party_doc.custom_additional_ids|length == 0)) %}
      <tr style="font-size:10pt; line-height:1.1; white-space:nowrap;">
        <td style="border:none; width:15%; vertical-align:middle;"></td><td style="border:none; width:35%; vertical-align:middle;"></td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; font-weight:bold; width:15%; white-space:nowrap; vertical-align:middle;">طريقة الدفع</td>
        <td style="border:none; padding:1pt; color:#111; text-align:right; width:35%; white-space:nowrap; vertical-align:middle;">{{ doc.mode_of_payment or "" }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- References Table -->
{% if doc.references %}
<div style="border: 2px solid #000; border-radius: 8px; overflow: hidden; direction: rtl; font-family: 'Cairo', Tahoma, Arial, sans-serif;">
  <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
    <thead>
      <tr style="border-bottom: 2px solid #666;">
        <th style="background: #eee; padding: 10px 6px; font-weight: bold; text-align: center; width: 30px; vertical-align:middle;">م</th>
        <th style="background: #eee; padding: 10px 6px; font-weight: bold; text-align: center; border-left: 1px solid #ccc; width: 120px; vertical-align:middle;">نوع المرجع</th>
        <th style="background: #eee; padding: 10px 6px; font-weight: bold; text-align: center; border-left: 1px solid #ccc; width: 120px; vertical-align:middle;">رقم المرجع</th>
        <th style="background: #eee; padding: 10px 6px; font-weight: bold; text-align: center; border-left: 1px solid #ccc; width: 100px; vertical-align:middle;">المبلغ المستحق</th>
        <th style="background: #eee; padding: 10px 6px; font-weight: bold; text-align: center; border-left: 1px solid #ccc; width: 100px; vertical-align:middle;">المبلغ المخصص</th>
      </tr>
    </thead>
    <tbody>
      {% for row in doc.references %}
        {% if loop.index % 2 == 0 %}
          {% if not loop.last %}
        <tr style="background: #f9f9f9; border-bottom: 1px dotted #aaa;">
          {% else %}
        <tr style="background: #f9f9f9;">
          {% endif %}
        {% else %}
          {% if not loop.last %}
        <tr style="border-bottom: 1px dotted #aaa;">
          {% else %}
        <tr>
          {% endif %}
        {% endif %}
          <td style="padding: 7px 5px; font-size: 0.9em; vertical-align: middle; text-align: center; width: 30px;">{{ loop.index }}</td>
          <td style="padding: 7px 5px; font-size: 0.9em; vertical-align: middle; text-align: center; width: 120px;">{{ row.reference_doctype }}</td>
          <td style="padding: 7px 5px; font-size: 0.9em; vertical-align: middle; text-align: center; width: 120px;">{{ row.reference_name }}</td>
          <td style="padding: 7px 5px; font-size: 0.9em; vertical-align: middle; text-align: center; direction: ltr; width: 100px;">
            {{ "{:,.2f}".format(row.outstanding_amount or 0) }}
          </td>
          <td style="padding: 7px 5px; font-size: 0.9em; vertical-align: middle; text-align: center; direction: ltr; width: 100px;">
            {{ "{:,.2f}".format(row.allocated_amount or 0) }}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Totals - Fixed LTR Layout -->
<div dir="ltr" style="direction: ltr; unicode-bidi: embed; width: 100%; margin-top: 10px; margin-bottom: 10px;">
  <table style="width:100%; border-collapse:collapse; direction: ltr;">
    <tr>
      <!-- Totals Column - Always Left -->
      <td style="width:300px; vertical-align:middle; padding-right:10px; direction: rtl; text-align: right;">
        <div style="margin:3px 0 0 0; border:1px solid #000; border-radius:8px; overflow:hidden; background:transparent; direction:rtl; font-family:'Arial',sans-serif; page-break-inside:avoid; unicode-bidi: embed; display: block;">
      <table style="width:100%; border-collapse:collapse; font-size:15px; margin:0; padding:0; line-height:1;">
        <tbody>
          {% if doc.payment_type == "Receive" %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">المبلغ المستلم</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.received_amount, currency=doc.paid_to_account_currency) | safe }}
            </td>
          </tr>
          {% elif doc.payment_type == "Pay" %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">المبلغ المدفوع</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.paid_amount, currency=doc.paid_from_account_currency) | safe }}
            </td>
          </tr>
          {% else %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">المبلغ المحول</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.paid_amount, currency=doc.paid_from_account_currency) | safe }}
            </td>
          </tr>
          {% endif %}

          {% if doc.total_allocated_amount %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">إجمالي المبالغ المخصصة</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.total_allocated_amount, currency=doc.paid_from_account_currency) | safe }}
            </td>
          </tr>
          {% endif %}

          {% if doc.unallocated_amount %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">المبلغ غير المخصص</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:1px solid #ddd; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.unallocated_amount, currency=doc.paid_from_account_currency) | safe }}
            </td>
          </tr>
          {% endif %}

          {% if doc.difference_amount %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:2px solid #000; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;">فرق المبلغ</th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:2px solid #000; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;">
              {{ frappe.utils.fmt_money(doc.difference_amount, currency=doc.paid_from_account_currency) | safe }}
            </td>
          </tr>
          {% else %}
          <tr>
            <th style="margin:0; padding:7px 5px; line-height:1; vertical-align:middle; border-bottom:2px solid #000; border-top:none; border-left:none; border-right:none; font-weight:bold; text-align:right; direction:rtl; display:table-cell;"></th>
            <td dir="ltr" style="margin:0; padding:7px 5px; line-height:1; border-bottom:2px solid #000; border-top:none; border-left:none; border-right:none; font-weight:bold; direction:ltr; white-space:nowrap; font-variant-numeric:tabular-nums; vertical-align:middle; display:table-cell; text-align:left;"></td>
          </tr>
          {% endif %}

          {% if doc.custom_tafqeet_amount %}
          <tr>
            <td colspan="2" style="margin:0; padding:7px 5px; font-size:16px; line-height:1.4; font-weight:bold; text-align:center; color:#222; border:none; word-wrap:break-word; white-space:normal; overflow-wrap:break-word;">
              {{ doc.custom_tafqeet_amount }}
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
      </td>
      
      <!-- Empty Column - Right Half -->
      <td style="width:200px; vertical-align:middle; padding-left:10px; direction: ltr; text-align: right;">
      </td>
    </tr>
  </table>
</div>

<!-- Additional Info -->
{% if doc.reference_no or doc.reference_date or doc.remarks %}
<div style="border:1.5pt solid #000; border-radius:8pt; background:#fff; width:100%; margin:10px 0 2pt 0; padding:10px; font-family:'Cairo',Tahoma,Arial,sans-serif; direction:rtl; box-sizing:border-box;">
  {% if doc.reference_no %}
  <div style="font-size:10pt; line-height:1.5; margin-bottom:5px;">
    <span style="font-weight:bold;">رقم المرجع:</span> {{ doc.reference_no }}
  </div>
  {% endif %}
  {% if doc.reference_date %}
  <div style="font-size:10pt; line-height:1.5; margin-bottom:5px;">
    <span style="font-weight:bold;">تاريخ المرجع:</span>
    {% set ref_dt = frappe.utils.get_datetime(doc.reference_date) %}
    {% set ref_weekday = ref_dt.weekday() %}
    {{ days_ar[ref_weekday] }} {{ "%02d"|format(ref_dt.day) }}-{{ "%02d"|format(ref_dt.month) }}-{{ ref_dt.year }}
  </div>
  {% endif %}
  {% if doc.remarks %}
  <div style="font-size:10pt; line-height:1.5;">
    <span style="font-weight:bold;">ملاحظات:</span> {{ doc.remarks }}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Signatures - Moved to bottom, PDF compatible -->
<div style="width:100%; margin-top:30px; margin-bottom:10px; overflow:hidden; background:#fff; font-family:'Cairo', Tahoma, Arial, sans-serif; line-height:1; border:none; padding:10px 0; page-break-inside:avoid;">
  <table style="width:100%; border:none; background:none; border-spacing:0; direction:rtl; line-height:1; margin:0; padding:0;">
    <tbody>
      <tr>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; padding:5px; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; width:50%;">
          {% if doc.payment_type == "Receive" %}
            المستلم
          {% elif doc.payment_type == "Pay" %}
            المدفوع له
          {% else %}
            المرسل
          {% endif %}
        </td>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; padding:5px; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; width:50%;">
          {% if doc.payment_type == "Receive" %}
            الدافع
          {% elif doc.payment_type == "Pay" %}
            المستلم
          {% else %}
            المستلم
          {% endif %}
        </td>
      </tr>
      <tr>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; height:30px; padding:5px 5px 0 5px;"></td>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; height:30px; padding:5px 5px 0 5px;"></td>
      </tr>
      <tr>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; padding:0 5px; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; height:1px;">
          <div style="width:150px; margin:0 auto; border-top:2px dotted #000;"></div>
        </td>
        <td style="font-family:'Cairo', Arial, sans-serif; font-size:0.92em; padding:0 5px; vertical-align:middle; color:#222; font-weight:700; letter-spacing:0.1px; text-align:center; border:none; height:1px;">
          <div style="width:150px; margin:0 auto; border-top:2px dotted #000;"></div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Footer from Letter Head -->
{% if footer %}
{{ footer | safe }}
{% endif %}
